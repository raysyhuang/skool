{% extends "base.html" %}

{% block title %}Skool - Parent Dashboard{% endblock %}

{% block theme_css %}
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        width: 100%;
        overflow-x: hidden;
        font-family: -apple-system, "PingFang SC", "Noto Sans SC", "Helvetica Neue", Arial, sans-serif;
    }

    body {
        background: #f5f6fa;
        min-height: 100dvh;
        padding: 20px;
        padding-bottom: 80px;
    }

    .dash-header {
        text-align: center;
        margin-bottom: 24px;
    }
    .dash-title {
        font-size: clamp(24px, 4vw, 36px);
        font-weight: 900;
        color: #2d3436;
    }

    .child-section {
        background: #fff;
        border-radius: 24px;
        padding: clamp(16px, 3vw, 32px);
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .child-name {
        font-size: clamp(22px, 4vw, 32px);
        font-weight: 800;
        color: #2d3436;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* ── Stats grid ── */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
    }
    .stat-box {
        background: #f5f6fa;
        border-radius: 16px;
        padding: 12px;
        text-align: center;
    }
    .stat-box .val {
        font-size: clamp(24px, 4vw, 36px);
        font-weight: 900;
        color: #2d3436;
    }
    .stat-box .lbl {
        font-size: 12px;
        color: #636e72;
        font-weight: 600;
        margin-top: 2px;
    }

    /* ── Section title ── */
    .section-title {
        font-size: clamp(16px, 2.5vw, 20px);
        font-weight: 800;
        color: #2d3436;
        margin-bottom: 10px;
    }

    /* ── Heatmap ── */
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 4px;
        margin-bottom: 20px;
    }
    .heatmap-cell {
        aspect-ratio: 1;
        border-radius: 4px;
        background: #ecf0f1;
        position: relative;
        min-width: 0;
    }
    .heatmap-cell.h1 { background: #a8e6cf; }
    .heatmap-cell.h2 { background: #55efc4; }
    .heatmap-cell.h3 { background: #00b894; }
    .heatmap-cell .hm-label {
        position: absolute;
        bottom: 2px;
        right: 3px;
        font-size: 8px;
        color: rgba(0,0,0,0.4);
    }

    /* ── Week chart ── */
    .week-chart {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        height: 80px;
        margin-bottom: 20px;
    }
    .day-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    .day-bar {
        width: 100%;
        max-width: 40px;
        border-radius: 6px 6px 0 0;
        background: linear-gradient(180deg, #6c5ce7, #a29bfe);
        min-height: 4px;
        transition: height 0.5s;
    }
    .day-label {
        font-size: 11px;
        color: #636e72;
        font-weight: 600;
    }
    .day-count {
        font-size: 12px;
        color: #2d3436;
        font-weight: 800;
    }

    /* ── Session history ── */
    .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    .history-table th {
        text-align: left;
        font-size: 12px;
        color: #636e72;
        font-weight: 700;
        padding: 6px 8px;
        border-bottom: 2px solid #ecf0f1;
    }
    .history-table td {
        padding: 8px;
        font-size: 14px;
        border-bottom: 1px solid #ecf0f1;
    }
    .score-good { color: #00b894; font-weight: 700; }
    .score-ok { color: #fdcb6e; font-weight: 700; }
    .score-low { color: #d63031; font-weight: 700; }

    /* ── Review schedule ── */
    .review-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 12px;
    }
    .review-card {
        background: #f5f6fa;
        border-radius: 12px;
        padding: 12px;
        text-align: center;
    }
    .review-card .rv-num {
        font-size: clamp(24px, 4vw, 36px);
        font-weight: 900;
        color: #6c5ce7;
    }
    .review-card .rv-lbl {
        font-size: 11px;
        color: #636e72;
        font-weight: 600;
    }
    .review-card.urgent .rv-num { color: #d63031; }
    .due-chars-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
    }
    .due-char-chip {
        background: #fff3f3;
        border: 1px solid #fab1a0;
        border-radius: 10px;
        padding: 4px 10px;
        font-size: 16px;
        font-weight: 700;
    }

    /* ── Drill button ── */
    .drill-btn {
        display: inline-block;
        background: linear-gradient(135deg, #e84393, #d63031);
        color: #fff;
        font-size: 16px;
        font-weight: 800;
        padding: 14px 28px;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        margin-bottom: 20px;
        min-width: 60px;
        min-height: 60px;
    }
    .drill-btn:active { transform: scale(0.96); }
    .drill-btn:disabled { opacity: 0.5; cursor: default; }

    /* ── Mastery bars ── */
    .mastery-chart {
        display: flex;
        gap: 6px;
        align-items: flex-end;
        height: 60px;
        margin-bottom: 20px;
    }
    .mastery-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    .mastery-bar {
        width: 100%;
        max-width: 50px;
        border-radius: 6px 6px 0 0;
        background: linear-gradient(180deg, #00b894, #55efc4);
        min-height: 4px;
    }
    .mastery-label {
        font-size: 11px;
        color: #636e72;
        font-weight: 600;
    }

    /* ── Weak chars table ── */
    .weak-table {
        width: 100%;
        border-collapse: collapse;
    }
    .weak-table th {
        text-align: left;
        font-size: 12px;
        color: #636e72;
        font-weight: 700;
        padding: 6px 8px;
        border-bottom: 2px solid #ecf0f1;
    }
    .weak-table td {
        padding: 8px;
        font-size: 14px;
        border-bottom: 1px solid #ecf0f1;
    }
    .weak-table .char-col {
        font-size: 20px;
        font-weight: 800;
    }
    .mastery-dot {
        display: inline-block;
        width: 8px; height: 8px;
        border-radius: 50%;
        background: #d63031;
    }
    .mastery-dot.m1 { background: #e17055; }
    .mastery-dot.m2 { background: #fdcb6e; }
    .mastery-dot.m3 { background: #ffeaa7; }
    .mastery-dot.m4 { background: #55efc4; }
    .mastery-dot.m5 { background: #00b894; }

    .back-link {
        position: fixed;
        bottom: clamp(16px, 3vh, 32px);
        left: 50%;
        transform: translateX(-50%);
        z-index: 2;
        background: #6c5ce7;
        border-radius: 20px;
        padding: 12px 28px;
        color: #fff;
        font-size: clamp(16px, 2.5vw, 20px);
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        -webkit-tap-highlight-color: transparent;
    }
    .back-link:active { transform: translateX(-50%) scale(0.95); }
</style>
{% endblock %}

{% block content %}
<div class="dash-header">
    <h1 class="dash-title">&#128202; Parent Dashboard</h1>
</div>

{% for child in children %}
<div class="child-section">
    <div class="child-name">
        <span>{% if child.user.name == 'Ellie' %}&#128135;{% else %}&#128102;{% endif %}</span>
        {{ child.user.name }}
    </div>

    {# ── Stats ── #}
    <div class="stats-grid">
        <div class="stat-box">
            <div class="val">{{ child.total_sessions }}</div>
            <div class="lbl">Sessions</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ child.accuracy }}%</div>
            <div class="lbl">Accuracy</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ child.user.streak }}</div>
            <div class="lbl">Streak</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ child.user.points }}</div>
            <div class="lbl">Points</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ child.user.stars }}</div>
            <div class="lbl">Stars</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ child.user.coins }}</div>
            <div class="lbl">Coins</div>
        </div>
    </div>

    {# ── Activity Heatmap (30 days) ── #}
    <div class="section-title">Activity Heatmap (30 days)</div>
    <div class="heatmap-grid">
        {% for cell in child.heatmap %}
        <div class="heatmap-cell {% if cell.count >= 3 %}h3{% elif cell.count == 2 %}h2{% elif cell.count == 1 %}h1{% endif %}"
             title="{{ cell.date }}: {{ cell.count }} sessions">
            <span class="hm-label">{{ cell.day_label }}</span>
        </div>
        {% endfor %}
    </div>

    {# ── Week chart ── #}
    <div class="section-title">Last 7 Days</div>
    <div class="week-chart">
        {% for day in child.week_data %}
        <div class="day-col">
            <span class="day-count">{{ day.count }}</span>
            <div class="day-bar" style="height: {{ day.pct }}%;"></div>
            <span class="day-label">{{ day.day }}</span>
        </div>
        {% endfor %}
    </div>

    {# ── Session History ── #}
    {% if child.session_history %}
    <div class="section-title">Recent Sessions</div>
    <table class="history-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Score</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody>
            {% for s in child.session_history %}
            {% set parts = s.score.split('/') %}
            {% set correct = parts[0]|int %}
            {% set total = parts[1]|int if parts|length > 1 else 5 %}
            <tr>
                <td>{{ s.date }}</td>
                <td>{{ s.game_type }}</td>
                <td class="{% if correct == total %}score-good{% elif correct >= total // 2 %}score-ok{% else %}score-low{% endif %}">
                    {{ s.score }}
                </td>
                <td>{{ s.duration }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {# ── Review Schedule (SM-2) ── #}
    <div class="section-title">Review Schedule</div>
    <div class="review-cards">
        <div class="review-card {% if child.review_schedule.due_today > 0 %}urgent{% endif %}">
            <div class="rv-num">{{ child.review_schedule.due_today }}</div>
            <div class="rv-lbl">Due Today</div>
        </div>
        <div class="review-card">
            <div class="rv-num">{{ child.review_schedule.due_tomorrow }}</div>
            <div class="rv-lbl">Tomorrow</div>
        </div>
        <div class="review-card">
            <div class="rv-num">{{ child.review_schedule.due_this_week }}</div>
            <div class="rv-lbl">This Week</div>
        </div>
    </div>
    {% if child.review_schedule.due_chars %}
    <div class="due-chars-row">
        {% for c in child.review_schedule.due_chars %}
        <span class="due-char-chip" title="{{ c.pinyin }} — {{ c.meaning }}">{{ c.character }}</span>
        {% endfor %}
    </div>
    {% endif %}

    {# ── Drill Button ── #}
    <button class="drill-btn" onclick="startDrill({{ child.user.id }})" id="drill-btn-{{ child.user.id }}">
        &#9889; Start Drill for {{ child.user.name }}
    </button>

    {# ── Mastery distribution ── #}
    <div class="section-title">Mastery Distribution</div>
    <div class="mastery-chart">
        {% set max_mastery = namespace(val=1) %}
        {% for bar in child.mastery_bars %}
            {% if bar.count > max_mastery.val %}{% set max_mastery.val = bar.count %}{% endif %}
        {% endfor %}
        {% for bar in child.mastery_bars %}
        <div class="mastery-col">
            <div class="mastery-bar" style="height: {{ (bar.count / max_mastery.val * 100)|round }}%;"></div>
            <span class="mastery-label">{{ bar.level }}</span>
        </div>
        {% endfor %}
    </div>

    {# ── Weakest characters ── #}
    {% if child.weakest %}
    <div class="section-title">Needs Practice</div>
    <table class="weak-table">
        <thead>
            <tr>
                <th>Character</th>
                <th>Pinyin</th>
                <th>Meaning</th>
                <th>Mastery</th>
            </tr>
        </thead>
        <tbody>
            {% for w in child.weakest[:8] %}
            <tr>
                <td class="char-col">{{ w.character }}</td>
                <td>{{ w.pinyin }}</td>
                <td>{{ w.meaning }}</td>
                <td><span class="mastery-dot m{{ w.mastery }}"></span> {{ w.mastery }}/5</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endfor %}

<a class="back-link" href="/game/">&#8592; Back</a>
{% endblock %}

{% block scripts %}
<script>
function startDrill(childId) {
    var btn = document.getElementById('drill-btn-' + childId);
    if (btn) { btn.disabled = true; btn.textContent = 'Starting...'; }

    fetch('/dashboard/drill/' + childId, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) {
            alert(data.error);
            if (btn) { btn.disabled = false; btn.textContent = '\u26A1 Start Drill'; }
        } else {
            /* Redirect to game — session was created for the child */
            alert('Drill session created with ' + data.characters + ' characters! Have ' + (childId === 1 ? 'them' : 'them') + ' log in to play.');
            if (btn) { btn.disabled = false; btn.textContent = '\u26A1 Start Drill'; }
        }
    })
    .catch(function() {
        alert('Something went wrong. Try again.');
        if (btn) { btn.disabled = false; btn.textContent = '\u26A1 Start Drill'; }
    });
}
</script>
{% endblock %}
