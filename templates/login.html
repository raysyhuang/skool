{% extends "base.html" %}

{% block title %}Skool - Who's Learning Today?{% endblock %}

{% block theme_css %}
<style>
    /* ── Login page styles ── */
    :root {
        --login-bg: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        --card-son: #ff6b35;
        --card-son-hover: #ff8c5a;
        --card-daughter: #e84393;
        --card-daughter-hover: #fd79a8;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        width: 100%; height: 100%;
        overflow: hidden;
        font-family: -apple-system, "PingFang SC", "Noto Sans SC", "Helvetica Neue", Arial, sans-serif;
    }

    body {
        background: var(--login-bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100dvh;
    }

    /* ── Floating stars background ── */
    .stars {
        position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;
    }
    .stars span {
        position: absolute;
        font-size: 28px;
        animation: float 6s ease-in-out infinite;
        opacity: 0.5;
    }
    .stars span:nth-child(1) { left: 10%; top: 15%; animation-delay: 0s; }
    .stars span:nth-child(2) { left: 25%; top: 70%; animation-delay: 1s; }
    .stars span:nth-child(3) { left: 55%; top: 20%; animation-delay: 2s; }
    .stars span:nth-child(4) { left: 80%; top: 60%; animation-delay: 0.5s; }
    .stars span:nth-child(5) { left: 40%; top: 85%; animation-delay: 3s; }
    .stars span:nth-child(6) { left: 70%; top: 10%; animation-delay: 1.5s; }
    .stars span:nth-child(7) { left: 90%; top: 40%; animation-delay: 2.5s; }
    .stars span:nth-child(8) { left: 5%; top: 50%; animation-delay: 4s; }

    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(10deg); }
    }

    /* ── Main container ── */
    .login-container {
        position: relative; z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 32px;
        padding: 24px;
        width: 100%;
        max-width: 800px;
    }

    .login-title {
        font-size: clamp(32px, 6vw, 56px);
        color: #fff;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        text-align: center;
        line-height: 1.3;
    }

    /* ── Avatar grid ── */
    .avatar-grid {
        display: flex;
        gap: 32px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .avatar-btn {
        width: clamp(180px, 28vw, 260px);
        height: clamp(200px, 32vw, 300px);
        border: none;
        border-radius: 32px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    .avatar-btn:active {
        transform: scale(0.94);
    }
    .avatar-btn:hover {
        transform: scale(1.04);
        box-shadow: 0 12px 40px rgba(0,0,0,0.35);
    }

    .avatar-btn[data-theme="racing"] {
        background: linear-gradient(145deg, var(--card-son), #e55a2b);
    }
    .avatar-btn[data-theme="racing"]:hover {
        background: linear-gradient(145deg, var(--card-son-hover), var(--card-son));
    }

    .avatar-btn[data-theme="pony"] {
        background: linear-gradient(145deg, var(--card-daughter), #c0236f);
    }
    .avatar-btn[data-theme="pony"]:hover {
        background: linear-gradient(145deg, var(--card-daughter-hover), var(--card-daughter));
    }

    .avatar-emoji {
        font-size: clamp(64px, 12vw, 100px);
        line-height: 1;
        filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
    }

    .avatar-name {
        font-size: clamp(28px, 5vw, 42px);
        font-weight: 800;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    /* Hidden form */
    .hidden-form { display: none; }

    /* ── Parent Login ── */
    .parent-login-btn {
        margin-top: 40px;
        background: none;
        border: none;
        color: rgba(255,255,255,0.7);
        font-size: 16px;
        cursor: pointer;
        text-decoration: underline;
    }
    
    .modal-overlay {
        display: none;
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        align-items: center; justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    
    .modal-content {
        background: #fff;
        padding: 32px;
        border-radius: 24px;
        text-align: center;
        width: 90%; max-width: 400px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-content h2 { margin-bottom: 20px; color: #2d3436; }
    .pin-input {
        font-size: 32px;
        letter-spacing: 8px;
        text-align: center;
        width: 100%;
        padding: 12px;
        border: 2px solid #dfe6e9;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    .modal-btns { display: flex; gap: 12px; }
    .modal-btn {
        flex: 1; padding: 14px;
        border: none; border-radius: 12px;
        font-size: 18px; font-weight: bold; cursor: pointer;
    }
    .btn-cancel { background: #dfe6e9; color: #636e72; }
    .btn-submit { background: #6c5ce7; color: #fff; }

    .error-msg { color: #d63031; margin-bottom: 12px; font-weight: bold; display: none; }
</style>
{% endblock %}

{% block content %}
{# Floating decorations #}
<div class="stars">
    <span>&#11088;</span><span>&#127775;</span><span>&#10024;</span><span>&#127752;</span>
    <span>&#127775;</span><span>&#11088;</span><span>&#10024;</span><span>&#127752;</span>
</div>

<div class="login-container">
    <h1 class="login-title">&#128218; Who's Learning Today?</h1>

    {# Avatar selection — tap to start #}
    <div class="avatar-grid">
        {% for user in users %}
        <button
            class="avatar-btn"
            data-theme="{{ user.theme }}"
            onclick="startGame({{ user.id }})"
            type="button"
        >
            <span class="avatar-emoji">
                {% if user.theme == "racing" %}&#128663;{% else %}&#129412;{% endif %}
            </span>
            <span class="avatar-name">{{ user.name }}</span>
        </button>
        {% endfor %}
    </div>

    <button class="parent-login-btn" onclick="openParentLogin()">Parent Dashboard</button>
</div>

<!-- Parent Login Modal -->
<div class="modal-overlay" id="parentModal">
    <div class="modal-content">
        <h2>Parent Login</h2>
        <div class="error-msg" id="pinError">Invalid PIN</div>
        <form method="POST" action="/login/parent">
            <input type="password" name="pin" class="pin-input" id="pinInput" maxlength="4" pattern="\d{4}" required placeholder="••••">
            <div class="modal-btns">
                <button type="button" class="modal-btn btn-cancel" onclick="closeParentLogin()">Cancel</button>
                <button type="submit" class="modal-btn btn-submit">Login</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.startGame = function(userId) {
        fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'user_id=' + encodeURIComponent(userId),
            redirect: 'manual'
        }).then(function() {
            window.location.href = '/game/';
        }).catch(function() {
            window.location.href = '/game/';
        });
    };

    window.openParentLogin = function() {
        document.getElementById('parentModal').classList.add('active');
        setTimeout(function() { document.getElementById('pinInput').focus(); }, 100);
    };

    window.closeParentLogin = function() {
        document.getElementById('parentModal').classList.remove('active');
        document.getElementById('pinInput').value = '';
    };

    // Check for login error
    if (window.location.search.includes('error=invalid_pin')) {
        openParentLogin();
        document.getElementById('pinError').style.display = 'block';
    }
</script>
{% endblock %}
