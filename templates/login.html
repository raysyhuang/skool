{% extends "base.html" %}

{% block title %}Skool - Who's Learning Today?{% endblock %}

{% block theme_css %}
<style>
    /* ── Login page styles ── */
    :root {
        --login-bg: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        --card-son: #ff6b35;
        --card-son-hover: #ff8c5a;
        --card-daughter: #e84393;
        --card-daughter-hover: #fd79a8;
        --pin-btn: #6c5ce7;
        --pin-btn-hover: #a29bfe;
        --pin-btn-active: #4834d4;
        --error-bg: #ff7675;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        width: 100%; height: 100%;
        overflow: hidden;
        font-family: -apple-system, "PingFang SC", "Noto Sans SC", "Helvetica Neue", Arial, sans-serif;
    }

    body {
        background: var(--login-bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100dvh;
    }

    /* ── Floating stars background ── */
    .stars {
        position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 0;
    }
    .stars span {
        position: absolute;
        font-size: 28px;
        animation: float 6s ease-in-out infinite;
        opacity: 0.5;
    }
    .stars span:nth-child(1) { left: 10%; top: 15%; animation-delay: 0s; }
    .stars span:nth-child(2) { left: 25%; top: 70%; animation-delay: 1s; }
    .stars span:nth-child(3) { left: 55%; top: 20%; animation-delay: 2s; }
    .stars span:nth-child(4) { left: 80%; top: 60%; animation-delay: 0.5s; }
    .stars span:nth-child(5) { left: 40%; top: 85%; animation-delay: 3s; }
    .stars span:nth-child(6) { left: 70%; top: 10%; animation-delay: 1.5s; }
    .stars span:nth-child(7) { left: 90%; top: 40%; animation-delay: 2.5s; }
    .stars span:nth-child(8) { left: 5%; top: 50%; animation-delay: 4s; }

    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(10deg); }
    }

    /* ── Main container ── */
    .login-container {
        position: relative; z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 32px;
        padding: 24px;
        width: 100%;
        max-width: 800px;
    }

    .login-title {
        font-size: clamp(32px, 6vw, 56px);
        color: #fff;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        text-align: center;
        line-height: 1.3;
    }

    /* ── Error banner ── */
    .error-banner {
        background: var(--error-bg);
        color: #fff;
        padding: 14px 28px;
        border-radius: 16px;
        font-size: 22px;
        font-weight: 700;
        text-align: center;
        animation: shake 0.4s ease-in-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-8px); }
        75% { transform: translateX(8px); }
    }

    /* ── Avatar grid ── */
    .avatar-grid {
        display: flex;
        gap: 32px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .avatar-btn {
        width: clamp(180px, 28vw, 260px);
        height: clamp(200px, 32vw, 300px);
        border: none;
        border-radius: 32px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    .avatar-btn:active {
        transform: scale(0.94);
    }
    .avatar-btn:hover {
        transform: scale(1.04);
        box-shadow: 0 12px 40px rgba(0,0,0,0.35);
    }

    .avatar-btn[data-theme="racing"] {
        background: linear-gradient(145deg, var(--card-son), #e55a2b);
    }
    .avatar-btn[data-theme="racing"]:hover {
        background: linear-gradient(145deg, var(--card-son-hover), var(--card-son));
    }

    .avatar-btn[data-theme="pony"] {
        background: linear-gradient(145deg, var(--card-daughter), #c0236f);
    }
    .avatar-btn[data-theme="pony"]:hover {
        background: linear-gradient(145deg, var(--card-daughter-hover), var(--card-daughter));
    }

    .avatar-emoji {
        font-size: clamp(64px, 12vw, 100px);
        line-height: 1;
        filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
    }

    .avatar-name {
        font-size: clamp(28px, 5vw, 42px);
        font-weight: 800;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    /* ── PIN pad overlay ── */
    .pin-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 100;
        align-items: center;
        justify-content: center;
    }
    .pin-overlay.active {
        display: flex;
    }

    .pin-card {
        background: #fff;
        border-radius: 32px;
        padding: clamp(24px, 4vw, 40px);
        width: clamp(320px, 50vw, 440px);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        animation: popIn 0.3s ease-out;
    }
    @keyframes popIn {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .pin-card-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    .pin-card-emoji {
        font-size: 56px;
    }
    .pin-card-name {
        font-size: 28px;
        font-weight: 800;
        color: #2d3436;
    }
    .pin-card-label {
        font-size: 20px;
        color: #636e72;
    }

    /* PIN dots display */
    .pin-dots {
        display: flex;
        gap: 16px;
        margin: 8px 0;
    }
    .pin-dot {
        width: 24px; height: 24px;
        border-radius: 50%;
        border: 3px solid #b2bec3;
        background: transparent;
        transition: background 0.15s, border-color 0.15s;
    }
    .pin-dot.filled {
        background: var(--pin-btn);
        border-color: var(--pin-btn);
    }

    /* Number pad */
    .pin-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        width: 100%;
        max-width: 360px;
    }

    .pin-key {
        height: clamp(64px, 10vw, 80px);
        border: none;
        border-radius: 18px;
        font-size: clamp(28px, 5vw, 36px);
        font-weight: 800;
        cursor: pointer;
        background: var(--pin-btn);
        color: #fff;
        transition: background 0.15s, transform 0.1s;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
    }
    .pin-key:hover {
        background: var(--pin-btn-hover);
    }
    .pin-key:active {
        background: var(--pin-btn-active);
        transform: scale(0.94);
    }

    .pin-key.back-key {
        background: #b2bec3;
        color: #2d3436;
        font-size: 24px;
    }
    .pin-key.back-key:hover {
        background: #dfe6e9;
    }

    .pin-key.cancel-key {
        background: #ff7675;
        color: #fff;
        font-size: 20px;
    }
    .pin-key.cancel-key:hover {
        background: #d63031;
    }

    /* Hidden form */
    .hidden-form { display: none; }
</style>
{% endblock %}

{% block content %}
{# Floating decorations #}
<div class="stars">
    <span>&#11088;</span><span>&#127775;</span><span>&#10024;</span><span>&#127752;</span>
    <span>&#127775;</span><span>&#11088;</span><span>&#10024;</span><span>&#127752;</span>
</div>

<div class="login-container">
    <h1 class="login-title">&#128218; Who's Learning Today?</h1>

    {% if error %}
    <div class="error-banner">{{ error }}</div>
    {% endif %}

    {# Avatar selection #}
    <div class="avatar-grid">
        {% for user in users %}
        <button
            class="avatar-btn"
            data-user-id="{{ user.id }}"
            data-user-name="{{ user.name }}"
            data-theme="{{ user.theme }}"
            onclick="openPin(this)"
            type="button"
        >
            <span class="avatar-emoji">
                {% if user.theme == "racing" %}&#128663;{% else %}&#129412;{% endif %}
            </span>
            <span class="avatar-name">{{ user.name }}</span>
        </button>
        {% endfor %}
    </div>
</div>

{# PIN pad overlay #}
<div class="pin-overlay" id="pinOverlay">
    <div class="pin-card">
        <div class="pin-card-header">
            <span class="pin-card-emoji" id="pinEmoji"></span>
            <span class="pin-card-name" id="pinName"></span>
            <span class="pin-card-label">Enter your PIN</span>
        </div>

        <div class="pin-dots">
            <div class="pin-dot" data-idx="0"></div>
            <div class="pin-dot" data-idx="1"></div>
            <div class="pin-dot" data-idx="2"></div>
            <div class="pin-dot" data-idx="3"></div>
        </div>

        <div class="pin-grid">
            <button class="pin-key" onclick="pinPress('1')" type="button">1</button>
            <button class="pin-key" onclick="pinPress('2')" type="button">2</button>
            <button class="pin-key" onclick="pinPress('3')" type="button">3</button>
            <button class="pin-key" onclick="pinPress('4')" type="button">4</button>
            <button class="pin-key" onclick="pinPress('5')" type="button">5</button>
            <button class="pin-key" onclick="pinPress('6')" type="button">6</button>
            <button class="pin-key" onclick="pinPress('7')" type="button">7</button>
            <button class="pin-key" onclick="pinPress('8')" type="button">8</button>
            <button class="pin-key" onclick="pinPress('9')" type="button">9</button>
            <button class="pin-key cancel-key" onclick="closePin()" type="button">&#10060;</button>
            <button class="pin-key" onclick="pinPress('0')" type="button">0</button>
            <button class="pin-key back-key" onclick="pinBack()" type="button">&#9003;</button>
        </div>
    </div>
</div>

{# Hidden form for submission #}
<form class="hidden-form" id="loginForm" method="POST" action="/login">
    <input type="hidden" name="user_id" id="formUserId">
    <input type="hidden" name="pin" id="formPin">
</form>
{% endblock %}

{% block scripts %}
<script>
(function() {
    let currentUserId = null;
    let currentPin = '';

    const overlay = document.getElementById('pinOverlay');
    const dots = document.querySelectorAll('.pin-dot');

    window.openPin = function(btn) {
        currentUserId = btn.dataset.userId;
        currentPin = '';
        updateDots();

        const theme = btn.dataset.theme;
        document.getElementById('pinEmoji').textContent = theme === 'racing' ? '\u{1F697}' : '\u{1F984}';
        document.getElementById('pinName').textContent = btn.dataset.userName;

        overlay.classList.add('active');
    };

    window.closePin = function() {
        overlay.classList.remove('active');
        currentPin = '';
        currentUserId = null;
        updateDots();
    };

    window.pinPress = function(digit) {
        if (currentPin.length >= 4) return;
        currentPin += digit;
        updateDots();

        if (currentPin.length === 4) {
            /* Short delay so the last dot fills visually */
            setTimeout(submitLogin, 200);
        }
    };

    window.pinBack = function() {
        if (currentPin.length === 0) return;
        currentPin = currentPin.slice(0, -1);
        updateDots();
    };

    function updateDots() {
        dots.forEach(function(dot, i) {
            dot.classList.toggle('filled', i < currentPin.length);
        });
    }

    function submitLogin() {
        document.getElementById('formUserId').value = currentUserId;
        document.getElementById('formPin').value = currentPin;
        document.getElementById('loginForm').submit();
    }

    /* Close overlay on backdrop tap */
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closePin();
    });
})();
</script>
{% endblock %}
